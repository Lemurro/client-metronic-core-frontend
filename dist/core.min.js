var lemurro={};lemurro.settings={},lemurro.sessionID="",lemurro.lightajax={},lemurro.init=function(e){lemurro.settings=Object.assign({onLoad:function(){}},e),lemurro._bindJSerrors(),lemurro.lightajax=new LightAjax({callbackAlert:function(e,r){swal(e,r,"error")},ajax:{beforeSend:function(e,r){/^(HEAD|OPTIONS|TRACE)$/i.test(r.type)||e.setRequestHeader("X-SESSION-ID",lemurro.sessionID)}}}),lemurro._bindCodeMask(),lemurro._bindPhoneMask(),lemurro._bindSelect2(),lemurro._bindTableFilter(),localforage.getItem("sessionID",function(e,r){lemurro.sessionID=r,lemurro.auth.check()}),localforage.getItem("lastSessionID",function(e,r){null!==r&&$("#js-user-return").show()})},lemurro._bindCodeMask=function(){$(".js-code-mask").each(function(){var e=$(this);Inputmask({mask:"9999"}).mask(e)})},lemurro._bindJSerrors=function(){function e(e,r,t,o,s){var a="JSON not found";window.JSON&&(a=JSON.stringify(s)),"object"==typeof e&&(r=e.filename,t=e.lineno,o=e.colno,a=e.error.stack,e=e.message),(new Image).src=pathServerAPI+"jserrors?msg="+encodeURIComponent(e)+"&file="+encodeURIComponent(r)+"&line="+encodeURIComponent(t)+"&col="+encodeURIComponent(o)+"&err="+encodeURIComponent(a)}window.addEventListener?window.addEventListener("error",e,!1):window.attachEvent?window.attachEvent("onerror",e):window.onerror=e},lemurro._bindPhoneMask=function(){$(".js-phone-mask").each(function(){var e=$(this);Inputmask({mask:"+7 (999) 999-99-99"}).mask(e)})},lemurro._bindSelect2=function(){$(".js-select2").each(function(){$(this).select2({language:"ru",placeholder:"Выберите из списка"})})},lemurro._bindTableFilter=function(){$(".tablefilter").TableFilter()},lemurro.authScreen=function(e){var r=$("#js-auth");"show"===e?($("#js-auth__get-form").show(),$("#js-auth__check-form").hide(),r.find('input[type="text"]').val(""),r.modal({backdrop:"static",keyboard:!1})):r.modal("hide")},lemurro.initPage=function(){lemurro.lightajax.get(!1,pathServerAPI+"user",{},function(e){if(e.hasOwnProperty("errors"))lemurro.showErrors(e.errors);else{if(lemurro.userinfo=e.data,$(".js-user__auth-id").text(lemurro.userinfo.auth_id),lemurro.userinfo.admin)$("body").find(".js-role").show();else for(var r in lemurro.userinfo.roles)lemurro.userinfo.roles[r].indexOf("read")!==-1&&$("body").find(".js-role__"+r).show();lemurro.settings.onLoad();var t=$("#js-page");if(t.length>0){var o=t.attr("data-page");if("lemurro.guide"===o)window.hasOwnProperty("lemurro")&&window.lemurro.hasOwnProperty("guide")&&window.lemurro.guide.hasOwnProperty("init")&&lemurro.guide.init();else{var s=window[o];void 0!==s&&s.hasOwnProperty("init")&&s.init()}}}})},lemurro.showErrors=function(e){if(1===e.length&&"401 Unauthorized"===e[0].status)lemurro.authScreen("show");else if(1===e.length&&"403 Forbidden"===e[0].status){var r=!0;e[0].hasOwnProperty("meta")&&e[0].meta.hasOwnProperty("redirect")&&(r=e[0].meta.redirect),r?location.assign(location.origin+"/403"):lemurro._showError(e[0].code,e[0].title)}else for(var t in e)lemurro._showError(e[t].code,e[t].title)},lemurro._showError=function(e,r){var t="Неизвестная ошибка",o="error";switch(e){case"danger":o="error",t="Критическая ошибка";break;case"warning":o="warning",t="Внимание!";break;case"info":o="info",t="Информация"}swal(t,r,o)},lemurro.auth={},lemurro.auth._timerID=null,lemurro.auth._runTimer=function(){null!==lemurro.auth._timerID&&clearInterval(lemurro.auth._timerID),lemurro.auth._timerID=setInterval(function(){var e=$("#js-auth__check-form"),r=e.find(".js-timer__count"),t=parseInt(r.text(),10);t>0?r.text(--t):(clearInterval(lemurro.auth._timerID),e.find(".js-timer").hide(),e.find(".js-resend").show())},1e3)},lemurro.auth.check=function(){lemurro.lightajax.get(!1,pathServerAPI+"auth/check",{},function(e){e.hasOwnProperty("errors")?lemurro.showErrors(e.errors):lemurro.initPage()})},lemurro.auth.checkCode=function(){var e=bowser.getParser(window.navigator.userAgent);lemurro.lightajax.post(!0,pathServerAPI+"auth/code",{auth_id:$("#js-auth__get-form").find('input[name="auth_id"]').val(),auth_code:$("#js-auth__check-form").find('input[name="auth_code"]').val(),device_info:{uuid:"WebApp",platform:e.parsedResult.os.name,version:e.parsedResult.os.version,manufacturer:e.parsedResult.browser.name,model:e.parsedResult.browser.version}},function(e){lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors")?($("#js-auth__check-form").find('input[name="auth_code"]').val(""),lemurro.showErrors(e.errors)):localforage.setItem("sessionID",e.data.session,function(){lemurro.sessionID=e.data.session,lemurro.authScreen("hide"),lemurro.auth.check()})})},lemurro.auth.getCode=function(){lemurro.lightajax.get(!0,pathServerAPI+"auth/code",{auth_id:$("#js-auth__get-form").find('input[name="auth_id"]').val()},function(e){if(lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors"))lemurro.showErrors(e.errors);else{e.data.hasOwnProperty("message")&&console.log(e.data.message,"AuthCode");var r=$("#js-auth__check-form");r.find(".js-timer").show(),r.find(".js-timer__count").text("60"),r.find(".js-resend").hide(),lemurro.auth._runTimer(),$("#js-auth__get-form").hide(),r.show()}})},lemurro.auth.logout=function(){lemurro.helper.showConfirm("Выход","Вы действительно хотите выйти из системы?","Да","Нет",null,null,function(){$(".js-user-data").html('<i class="fas fa-spinner fa-pulse"></i>'),localforage.clear(),lemurro.sessionID="",lemurro.authScreen("show")},null)},lemurro.helper={},lemurro.helper.clearFields=function(e){e.find('input[type="text"],input[type="password"],input[type="email"],input[type="number"],input[type="tel"],input[type="url"],input[type="date"],input[type="time"]').val(""),e.find("textarea").val(""),e.find("select").each(function(){$(this).val(null).trigger("change")}),e.find('input[type="checkbox"]').each(function(){$(this).prop("checked",!1)}),e.find('input[type="radio"]').each(function(){$(this).prop("checked",!1)})},lemurro.helper.decimal=function(e){return parseFloat(e.replace(/,/g,"."))},lemurro.helper.isRole=function(e,r,t,o){var s=setInterval(function(){if(lemurro.hasOwnProperty("userinfo")){if(clearInterval(s),lemurro.userinfo.admin)return t(),!0;if(lemurro.userinfo.roles.hasOwnProperty(e)){var a;for(a in lemurro.userinfo.roles[e])if(lemurro.userinfo.roles[e][a]===r&&!isEmpty(t))return t(),!0}if(!isEmpty(o))return o(),!1}},500)},lemurro.helper.showConfirm=function(e,r,t,o,s,a,n,i){swal({title:e,html:r,type:"",allowOutsideClick:!1,showCancelButton:!0,confirmButtonText:t,cancelButtonText:o,onOpen:s,preConfirm:a}).then(function(e){e.value?n():null!==i&&i()})},lemurro.tabs={},lemurro.tabs.showTab=function(e){var r=$("#js-tabs__links"),t=$("#js-tabs__contents");r.find(".nav-link").removeClass("active show"),t.find(".tab-pane").removeClass("active show"),r.find('a[data-target="#'+e+'"]').addClass("active show"),t.find("#"+e).addClass("active show")},lemurro.tabs.tabInsertEdit=function(e){var r=$("#js-tabs__links"),t=$("#js-tabs__contents");"show"===e?(r.find('a[data-target="#tab-form"]').parent().show(),t.find("#tab-form").addClass("active show"),lemurro.tabs.showTab("tab-form")):(r.find('a[data-target="#tab-form"]').parent().hide(),t.find("#tab-form").removeClass("active show"),lemurro.tabs.showTab("tab-list"))},lemurro.guide={},lemurro.guide.init=function(){lemurro.guide.type=$("#js-page").attr("data-type"),lemurro.guide.templates={item:Template7.compile($("#js-tpl-guide__item").html())},lemurro.guide._getData()},lemurro.guide._getData=function(){lemurro.lightajax.get(!0,pathServerAPI+"guide/"+lemurro.guide.type,{},function(e){if(lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors"))lemurro.showErrors(e.errors);else{if($("#js-guide__loader").hide(),0===e.data.count)$("#js-guide__empty").show();else{var r="";for(var t in e.data.items)r+=lemurro.guide.templates.item(e.data.items[t]);$("#js-guide__items").html(r),$("#js-guide__list").show()}void 0!==e.data.js_class&&window.hasOwnProperty(e.data.js_class)&&window[e.data.js_class].hasOwnProperty("init")&&window[e.data.js_class].init()}})},lemurro.guide.edit=function(e,r){lemurro.lightajax.get(!0,pathServerAPI+"guide/"+lemurro.guide.type+"/"+e,{},function(t){if(lemurro.lightajax.preloader("hide"),t.hasOwnProperty("errors"))lemurro.showErrors(t.errors);else{var o=$("#js-guide-form");o.attr("data-id",e),o.find(".js-title").text("Редактирование записи"),$("#js-guide__button-insert").hide(),$("#js-guide__button-save").show(),$("#js-tab-form-button").html('<i class="fas fa-pencil-alt"></i> Редактировать'),lemurro.tabs.tabInsertEdit("show"),r(t)}})},lemurro.guide.insert=function(e,r){lemurro.lightajax.post(!0,pathServerAPI+"guide/"+lemurro.guide.type,{data:e},function(e){lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors")?lemurro.showErrors(e.errors):r(e)})},lemurro.guide.remove=function(e,r,t){swal({title:"Удаление записи",html:'Вы хотите удалить <strong>"'+r+'"</strong>?',type:"warning",showCancelButton:!0,confirmButtonText:"Да, удалить!",cancelButtonText:"Отмена"}).then(function(r){r.value&&lemurro.lightajax.post(!0,pathServerAPI+"guide/"+lemurro.guide.type+"/"+e+"/remove",{},function(e){lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors")?lemurro.showErrors(e.errors):t(e)})})},lemurro.guide.save=function(e,r){lemurro.lightajax.post(!0,pathServerAPI+"guide/"+lemurro.guide.type+"/"+e.id,{data:e},function(e){lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors")?lemurro.showErrors(e.errors):r(e)})},lemurro.guide.showInsertForm=function(e){var r=$("#js-guide-form");r.attr("data-id","0"),r.find(".js-title").text("Добавление записи"),lemurro.helper.clearFields(r),$("#js-guide__button-insert").show(),$("#js-guide__button-save").hide(),$("#js-tab-form-button").html('<i class="fas fa-plus"></i> Добавить'),lemurro.tabs.tabInsertEdit("show"),e()},lemurro.users={},lemurro.users.edit=function(e,r){lemurro.lightajax.get(!0,pathServerAPI+"users/"+e,{},function(t){if(lemurro.lightajax.preloader("hide"),t.hasOwnProperty("errors"))lemurro.showErrors(t.errors);else{var o=$("#js-user-form");o.attr("data-id",e),o.find(".js-title").text("Редактирование пользователя"),$("#js-user__button-insert").hide(),$("#js-user__button-save").show(),$("#js-tab-form-button").html('<i class="fas fa-pencil-alt"></i> Редактировать'),lemurro.tabs.tabInsertEdit("show"),r(t)}})},lemurro.users.getData=function(){lemurro.lightajax.get(!0,pathServerAPI+"users",{},function(e){if(lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors"))lemurro.showErrors(e.errors);else{var r="";for(var t in e.data.items)r+=users.templates.item(e.data.items[t]);$("#js-users__items").html(r),localforage.getItem("lastSessionID",function(e,r){null!==r&&$("#js-users__items").find(".js-login-by-user").hide()})}})},lemurro.users.insert=function(e,r){lemurro.lightajax.post(!0,pathServerAPI+"users",{data:e},function(e){lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors")?lemurro.showErrors(e.errors):r(e)})},lemurro.users.loginByUser=function(e){swal({title:"Войти под пользователем?",html:"",type:"warning",showCancelButton:!0,confirmButtonText:"Да",cancelButtonText:"Нет"}).then(function(r){r.value&&lemurro.lightajax.post(!0,pathServerAPI+"users/login_by_user",{user_id:e},function(e){lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors")?lemurro.showErrors(e.errors):localforage.setItem("lastSessionID",lemurro.sessionID,function(){localforage.setItem("sessionID",e.data.session,function(){location.replace(location.origin)})})})})},lemurro.users.remove=function(e,r,t){swal({title:"Удаление пользователя",html:'Вы хотите удалить <strong>"'+r+'"</strong>?',type:"warning",showCancelButton:!0,confirmButtonText:"Да, удалить!",cancelButtonText:"Отмена"}).then(function(r){r.value&&lemurro.lightajax.post(!0,pathServerAPI+"users/"+e+"/remove",{},function(e){lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors")?lemurro.showErrors(e.errors):t(e)})})},lemurro.users["return"]=function(){localforage.getItem("lastSessionID",function(e,r){var t=r;return null===t?void swal("Ошибка","Прошлая сессия отсутствует","error"):void swal({title:"Вернуться обратно?",html:"",type:"warning",showCancelButton:!0,confirmButtonText:"Да",cancelButtonText:"Нет"}).then(function(e){e.value&&localforage.removeItem("lastSessionID",function(){localforage.setItem("sessionID",t,function(){location.replace(location.origin)})})})})},lemurro.users.save=function(e,r){lemurro.lightajax.post(!0,pathServerAPI+"users/"+e.id,{data:e},function(e){lemurro.lightajax.preloader("hide"),e.hasOwnProperty("errors")?lemurro.showErrors(e.errors):r(e)})},lemurro.users.showInsertForm=function(e){var r=$("#js-user-form");r.attr("data-id","0"),r.find(".js-title").text("Добавление пользователя"),lemurro.helper.clearFields(r),$("#js-user__button-insert").show(),$("#js-user__button-save").hide(),$("#js-tab-form-button").html('<i class="fas fa-plus"></i> Добавить'),lemurro.tabs.tabInsertEdit("show"),e()};